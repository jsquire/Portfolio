# ASP.NET Core Authentication Custom Nonce Protection

### Summary

Rarely, the OpenId Connect provider in the ASP.NET Core authentication library generates a nonce cookie containing the character sequence  '--' (two dashes), which is flagged as a potential SQL injection attack by [rule #942440](https://github.com/SpiderLabs/owasp-modsecurity-crs/blob/v3.2/dev/rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf) of the OWSAP common rule set v3.

The nonce value is generated by the middleware and encoded for transport to the identity provider (in this case, Azure Active Directory B2C) as a query string parameter.  Deeper in the stack, the middleware applies protection to the nonce value and then encodes the resulting bytes before writing them to the nonce cookie.  The encoding for the cookie makes use of the secondary Base64 alphabet, which includes the dash ('-') as a legal character.  When the encoded cookie value randomly contains a sequence that encodes to consecutive dashes, a false positive is triggered against the web application firewall rule set.

Authored in late 2018 to illustrate a work-around using a custom formatter for the nonce cookie, the code herein is inconsistent in terms of conventions, polish, and appropriateness for production use.  The safe bet would be to consider it largely prototype-level.  It is based on the [Azure Active Directory B2C sample application for ASP.NET Core](https://github.com/Azure-Samples/active-directory-b2c-dotnetcore-webapp) and the original code from that sample has been left as-is wherever possible.  Because the open-source sample is used as the basis, the original license, read-me, and other root assets were left in tact in the source directory. 

The relevant areas of customization are:
 
- `OpenIdConnectSetup` _(lines 33-38, 41-42, 51-62)_
- `OpenIdConnectNonceStringDataFormat` 
- `Utf8ByteSerializer`
- `OpenIdConnectNonceStringDataFormatTests`
- `Utf8ByteSerializerTests`

### Structure

* **src**  
  _The container for project source code including the original assets from the [Azure Active Directory B2C sample application for ASP.NET Core](https://github.com/Azure-Samples/active-directory-b2c-dotnetcore-webapp) and changes made for the prototype._
  
### Details

- Base64 encoding allows for a sequence of bytes to be represented in a string format; the Base64 spec defines two legal sets of characters – one that is intended to be the primary alphabet for the encoding, and an extended set intended to allow for the use of Base64 in the context of file names and URLs.  The primary difference is replacing "+" with "-"  and replacing "/" with "_" when moving to the URL-safe set.  ([RFC 4648](https://tools.ietf.org/html/rfc4648))
	
- After being generated, the nonce needs to be sent to the identity provider and preserved by the application for later use.  The nonce is transmitted as part of the request URL and, therefore, must be encoded in a way that is safe for transport.  Because of this, encoding makes use of the URL-safe Base64 alphabet, which opens the possibility of seeing consecutive dashes.
	
- The ASP.NET Core Authentication library preserves the nonce in a cookie.  In order to keep the cookie data safe, it is protected using the ASP.NET Core data protection framework.  The protection results in a byte sequence that is then encoded for writing to the cookie value.  The default encoding uses the URL-safe Base64 character set.  

- While many application frameworks encode cookie values with URL safety in mind, the use of the standard Base64 alphabet for encoding is permissible the cookie specification.  According to [RFC 6265](https://www.ietf.org/rfc/rfc6265.txt), a cookie value may contain US-ASCII characters, excluding control characters, and that only three types of characters must be encoded: semicolon, comma, and white space.  _(see page 8)_
	
- No matter what the value of the generated nonce, after passing through the default data protection scheme there exists the possibility that the value can contain a character sequence that the OWSAP CRS patterns flag as a false positive due to the encoding. 
	 
- The protected value in the nonce cookie needs to be compared to the nonce in the JavaScript Web Token (JWT) returned by the identity provider as a means of validating the token.  As a result, the cookie value must be read, decoded, and unprotected into the original nonce value.  This means that the cookie value cannot be sanitized simply by removing the offending character sequence after data protection.  In theory, it would be possible to manually the alphabet substitution from the URL-safe Base64 character set to the standard character set.   Doing so is brittle, however, as it ​relies on the implementation of how the ASP.NET Core library performs the default encoding, which could change in the future.
	
- In the ASP.NET Core authentication library, data protection is done as part of the middleware and consists of a pipeline for protecting, serializing, and formatting the nonce value.  The pipeline can be customized and extended, but most of the documentation for the associated classes hasn't been written yet and exists on the Docs site as just stubs.   Thankfully, the framework is open source and could be used for reference.
	
- The class responsible for facilitating the protection, serialization, and encoding of the nonce is, by default,[` SecureDataFormat`](https://github.com/aspnet/AspNetCore/blob/02ca469ea1ee06be2769ebbb0252bc88847d6378/src/Security/src/Microsoft.AspNetCore.Authentication/Data/SecureDataFormat.cs).  This class has a serializer and a protector injected into it, but does not allow for replacement of the encoder.  It hard codes use of an internal framework class, [`WebEncoders`](https://github.com/aspnet/Extensions/blob/master/src/Shared/src/WebEncoders/WebEncoders.cs), and uses its `Base64UrlEncode` method. _(see lines 253-314)_
	
- In order to change the method of encoding, a new class that implements the [`ISecureDataFormat<string>`](https://github.com/aspnet/AspNetCore/blob/02ca469ea1ee06be2769ebbb0252bc88847d6378/src/Security/src/Microsoft.AspNetCore.Authentication/Data/ISecureDataFormat.cs) interface is needed.  The class in the prototype mimics the functionality of the default class, just replacing the encoding.  In the prototype, the [`System.Convert`](https://github.com/Microsoft/referencesource/blob/master/mscorlib/system/convert.cs) class was used, as the `ToBase64String` and `FromBase64String` methods use the standard Base64 character set.  _(see lines 140-144)_
	
- To use the new class, it has to be set on the [`OpenIdConfigurationOptions.StringDataFormat`](https://github.com/aspnet/Security/blob/7e14b052ea9cb935ec4f5cb0485b4edb5d41297a/src/Microsoft.AspNetCore.Authentication.OpenIdConnect/OpenIdConnectOptions.cs) property. _(see line 254)_   It is worth noting that if this property s not set by the application code, it is not injected via the ASP.NET dependency injection container; it is created and set within the [`OpenIdConnectPostConfigurationOptions`](https://github.com/aspnet/Security/blob/7e14b052ea9cb935ec4f5cb0485b4edb5d41297a/src/Microsoft.AspNetCore.Authentication.OpenIdConnect/OpenIdConnectPostConfigureOptions.cs) class. _(see line 47)_  As a result, it isn't possible to just override a service registration;  it must be explicitly set.
	
- The approach taken within the prototype does not make any changes to the way that a nonce is generated nor to how the data is protected; it only modifies the means by which the cookie value is encoded.   As a result, there should be no weakening of the default security model or increased risk in using this approach in production.​

### Other Possible Concerns

- While I have not inspected deeply, the other cookies within the ASP.NET Core ecosystem appear to make use of the URL-safe form of Base64 encoding for cookie values, including such artifacts as the session cookie and the anti-forgery cookie.  Each may have the same underlying concern about randomly causing failures due to being flagged by web application firewalls that implement the OWSAP CRS v3.

- I have not reviewed each of the patterns in the OWSAP common rule set to determine if the use of an alternate encoding would prevent all issues.  There may be rules that are not as easily worked around which may be susceptible to false positives from characters in the standard Base64 alphabet.
